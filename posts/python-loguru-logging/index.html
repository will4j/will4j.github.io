<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>Python 工程化：Loguru 日志集成 - 程序员水王</title><meta name=author content>
<meta name=author-link content><meta name=description content="Python 工程化：loguru 日志集成"><meta name=keywords content="loguru,logging,python"><meta itemprop=name content="Python 工程化：Loguru 日志集成"><meta itemprop=description content="Python 工程化：loguru 日志集成"><meta itemprop=datePublished content="2024-01-04T10:11:49+08:00"><meta itemprop=dateModified content="2024-01-04T22:04:28+08:00"><meta itemprop=wordCount content="3449"><meta itemprop=keywords content="Python,"><meta property="og:title" content="Python 工程化：Loguru 日志集成"><meta property="og:description" content="Python 工程化：loguru 日志集成"><meta property="og:type" content="article"><meta property="og:url" content="https://will4j.github.io/posts/python-loguru-logging/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-04T10:11:49+08:00"><meta property="article:modified_time" content="2024-01-04T22:04:28+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Python 工程化：Loguru 日志集成"><meta name=twitter:description content="Python 工程化：loguru 日志集成"><meta name=application-name content="程序员水王"><meta name=apple-mobile-web-app-title content="程序员水王"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=/favicon.svg><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://will4j.github.io/posts/python-loguru-logging/><link rel=prev href=https://will4j.github.io/posts/taskfile-the-alternatives-to-makefile/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Python 工程化：Loguru 日志集成","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/will4j.github.io\/posts\/python-loguru-logging\/"},"genre":"posts","keywords":"Python","wordcount":3449,"url":"https:\/\/will4j.github.io\/posts\/python-loguru-logging\/","datePublished":"2024-01-04T10:11:49+08:00","dateModified":"2024-01-04T22:04:28+08:00","license":"by 水王","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"水王"},"description":"Python 工程化：loguru 日志集成"}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=left><div class=header-title><a href=/ title=程序员水王><span class=header-title-pre><i class="fa fa-code">&nbsp</i></span><span id=typeit-header-desktop class=typeit></span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/><i class="fa-solid fa-home fa-fw fa-sm" aria-hidden=true></i> 首页</a></li><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th-list fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=程序员水王><span class=header-title-pre><i class="fa fa-code">&nbsp</i></span><span id=typeit-header-title-mobile class=typeit></span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/><i class="fa-solid fa-home fa-fw fa-sm" aria-hidden=true></i> 首页</a></li><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th-list fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><nav aria-label=breadcrumb class=breadcrumb-container><ol class=breadcrumb><li class=breadcrumb-item><a href=/posts/ title=文章>文章</a></li><li class="breadcrumb-item active" aria-current=page>Python 工程化：Loguru 日志集成</li></ol></nav><main class=container><aside class=toc id=toc-auto><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>Python 工程化：Loguru 日志集成</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="fa-solid fa-user-circle" aria-hidden=true></i>
水王</span></span>
<span class=post-category>收录于 <a href=/categories/python-eng/><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> Python 工程化</a></span></div><div class=post-meta-line><span title="发布于 2024-01-04 10:11:49"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden=true></i><time datetime=2024-01-04>2024-01-04</time></span>&nbsp;<span title="更新于 2024-01-04 22:04:28"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden=true></i><time datetime=2024-01-04>2024-01-04</time></span>&nbsp;<span title="3449 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 3500 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 7 分钟</span>&nbsp;<span id=busuanzi_container_page_pv class="busuanzi_visitors comment-visitors" data-flag-title="Python 工程化：Loguru 日志集成">
<i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_page_pv>-</span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ol><li><a href=#python-日志方案>Python 日志方案</a><ol><li><a href=#python-标准日志模块>Python 标准日志模块</a></li><li><a href=#loguru-日志框架>Loguru 日志框架</a></li><li><a href=#日志方案选择>日志方案选择</a></li></ol></li><li><a href=#loguru-日志集成>Loguru 日志集成</a><ol><li><a href=#基于字典的日志配置>基于字典的日志配置</a><ol><li><a href=#python-对象访问解析器>Python 对象访问解析器</a></li><li><a href=#日志配置访问解析器>日志配置访问解析器</a></li><li><a href=#用户自定义对象>用户自定义对象</a></li></ol></li><li><a href=#loguru-日志处理器实现>Loguru 日志处理器实现</a><ol><li><a href=#yaml-配置样例>yaml 配置样例</a></li><li><a href=#拦截器实现>拦截器实现</a></li></ol></li></ol></li><li><a href=#总结>总结</a></li><li><a href=#参考资料>参考资料</a></li></ol></nav></div></div><div class=content id=content><div class="details admonition abstract open"><div class="details-summary admonition-title"><i class="icon fa-solid fa-list-ul fa-fw" aria-hidden=true></i>摘要<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>这篇文章综合考虑标准日志模块的统一接口以及 <code>Loguru</code> 日志框架的简便性，采用仅以标准日志模块作为日志门面，实际日志使用 <code>Loguru</code> 来输出的方案，并提供了方案的具体实现。通过这种方式，项目可以使用如 <code>YAML</code> 等纯文本配置文件进行日志配置，日志打印时只使用标准日志模块接口，使得业务代码和具体日志实现相隔离。</div></div></div><p>日志在开发中的地位不言而喻，规范的日志一如“书同文，车同轨”一般，不仅能灵活的进行日志搜索和过滤，更能清晰的展示业务流程，成为跨系统调用的“硬通货”。在排查线上问题时，关键日志往往能提供重要线索，帮助从一团乱麻中快速定位问题，甚至能省下数小时时间。更进一步，日志也作为系统的数据资产，从海量日志中可以分析出很多有价值的业务信息。</p><h2 id=python-日志方案>Python 日志方案</h2><h3 id=python-标准日志模块>Python 标准日志模块</h3><p>Python 标准日志模块[<a href=https://docs.python.org/3/library/logging.html target=_blank rel="external nofollow noopener noreferrer">1</a>] <code>logging</code> 由 PEP 282 提案[<a href=https://peps.python.org/pep-0282/ target=_blank rel="external nofollow noopener noreferrer">2</a>]引入，其最大的好处是提供了全 Python 环境统一的日志接口，使得所有 Python 模块的日志得以整合，也就是说除了记录应用本身的日志外，第三方模块的日志也可以一同记录，从而为应用提供更全面完备的日志信息。</p><p>标准日志模块按照层级结构组织[<a href=https://docs.python.org/3/howto/logging.html#advanced-logging-tutorial target=_blank rel="external nofollow noopener noreferrer">3</a>]，核心包括四类组件：<code>loggers</code>，<code>handlers</code>，<code>filters</code> 和 <code>formatters</code>，它们之间的关系如下图所示：</p><p><img loading=lazy src=/posts/python-loguru-logging/images/python-logging.png srcset="/posts/python-loguru-logging/images/python-logging.png?size=small, /posts/python-loguru-logging/images/python-logging.png?size=medium 1.5x, /posts/python-loguru-logging/images/python-logging.png?size=large 2x" sizes=auto data-title="Python Logging" data-alt="Python Logging" style="--width:2038px;--aspect-ratio:2038 / 900;background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>除了根据日志级别直接进行过滤外，日志输出的主体流程分为四步（详细流程可参考[<a href=https://docs.python.org/3/howto/logging.html#logging-flow target=_blank rel="external nofollow noopener noreferrer">4</a>]）：</p><ol><li><code>logger</code> 创建日志记录，首先根据 <code>logger</code> 过滤器规则对日志进行筛选；</li><li><code>logger</code> 将筛选出的日志记录传递给对应的日志处理器 <code>handlers</code> 处理；</li><li>每个 <code>handler</code> 根据其自身的过滤器规则筛选出需要处理的日志记录；</li><li><code>handler</code> 将筛选出的日志记录使用 <code>formatter</code> 格式化后进行输出；</li></ol><p>标准日志模块使用示例如下：</p><div class=highlight id=id-1><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Hello World&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>INFO</span><span class=p>:</span><span class=n>__main__</span><span class=p>:</span><span class=n>Hello</span> <span class=n>World</span></span></span></code></pre></td></tr></table></div></div><h3 id=loguru-日志框架>Loguru 日志框架</h3><p>Loguru [<a href=https://loguru.readthedocs.io/en/stable/overview.html#features target=_blank rel="external nofollow noopener noreferrer">5</a>]是最受欢迎的 Python 第三方日志框架，提供开箱即用的日志入口，同时支持彩色日志输出，使用效果如下：</p><p><img loading=lazy src=/posts/python-loguru-logging/images/loguru-colored.png srcset="/posts/python-loguru-logging/images/loguru-colored.png?size=small, /posts/python-loguru-logging/images/loguru-colored.png?size=medium 1.5x, /posts/python-loguru-logging/images/loguru-colored.png?size=large 2x" sizes=auto data-title="Loguru Colored Log" data-alt="Loguru Colored Log" style="--width:1020px;--aspect-ratio:1020 / 200;background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>在配置方式上，Loguru 摒弃了标准日志模块的 <code>loggers</code>，<code>handlers</code> 等层级结构，统一采用 <code>add</code> 方法，使得配置非常简单：</p><div class=highlight id=id-2><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>from</span> <span class=nn>loguru</span> <span class=kn>import</span> <span class=n>logger</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>logger</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=s2>&#34;out_</span><span class=si>{time}</span><span class=s2>.log&#34;</span><span class=p>,</span> <span class=n>rotation</span><span class=o>=</span><span class=s2>&#34;500 MB&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;Hello World&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>2024</span><span class=o>-</span><span class=mi>01</span><span class=o>-</span><span class=mi>04</span> <span class=mi>11</span><span class=p>:</span><span class=mi>06</span><span class=p>:</span><span class=mf>12.237</span> <span class=o>|</span> <span class=n>INFO</span>     <span class=o>|</span> <span class=n>__main__</span><span class=p>:</span><span class=o>&lt;</span><span class=n>module</span><span class=o>&gt;</span><span class=p>:</span><span class=mi>1</span> <span class=o>-</span> <span class=n>Hello</span> <span class=n>World</span></span></span></code></pre></td></tr></table></div></div><div class=highlight id=id-3><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ cat out_2024-01-04_11-06-00_178249.log
</span></span><span class=line><span class=cl>2024-01-04 11:06:12.237 <span class=p>|</span> INFO     <span class=p>|</span> __main__:&lt;module&gt;:1 - Hello World</span></span></code></pre></td></tr></table></div></div><p>另外，Loguru 支持包含运行时变量值的堆栈打印，可以直观的看到调用上下文信息，以除零异常为例：</p><div class=highlight id=id-4><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># main.py</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>loguru</span> <span class=kn>import</span> <span class=n>logger</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>divide</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>a</span> <span class=o>/</span> <span class=n>b</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>nested</span><span class=p>(</span><span class=n>c</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>divide</span><span class=p>(</span><span class=mi>5</span><span class=p>,</span> <span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>exception</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>nested</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><div class=highlight id=id-5><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ python main.py
</span></span><span class=line><span class=cl>2024-01-04 10:44:02.288 <span class=p>|</span> ERROR    <span class=p>|</span> __main__:nested:10 - division by zero
</span></span><span class=line><span class=cl>Traceback <span class=o>(</span>most recent call last<span class=o>)</span>:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  File <span class=s2>&#34;main.py&#34;</span>, line 13, in &lt;module&gt;
</span></span><span class=line><span class=cl>    nested<span class=o>(</span>0<span class=o>)</span>
</span></span><span class=line><span class=cl>    └ &lt;<span class=k>function</span> nested at 0x1036a1080&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&gt; File <span class=s2>&#34;main.py&#34;</span>, line 8, in nested
</span></span><span class=line><span class=cl>    <span class=k>return</span> divide<span class=o>(</span>5, c<span class=o>)</span>
</span></span><span class=line><span class=cl>           │         └ <span class=m>0</span>
</span></span><span class=line><span class=cl>           └ &lt;<span class=k>function</span> divide at 0x10364a340&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  File <span class=s2>&#34;main.py&#34;</span>, line 4, in divide
</span></span><span class=line><span class=cl>    <span class=k>return</span> a / b
</span></span><span class=line><span class=cl>           │   └ <span class=m>0</span>
</span></span><span class=line><span class=cl>           └ <span class=m>5</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ZeroDivisionError: division by zero</span></span></code></pre></td></tr></table></div></div><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fa-solid fa-pencil-alt fa-fw" aria-hidden=true></i>注意<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>生产环境日志配置应该通过 <code>diagnose=False</code> 参数关闭堆栈详情打印，以避免泄露敏感信息。</div></div></div><h3 id=日志方案选择>日志方案选择</h3><p>总体来看，Python 标准日志模块提供统一的日志接口且功能强大，但是其配置相对复杂，在日志输出样式以及对异常诊断的帮助上表现不如 Loguru；后者在一定程度上补齐了标准日志模块的短板，然而其使用具有一定的侵入性，一方面使得项目代码跟日志框架耦合，另一方面也不利于整合其他模块日志。</p><p>回忆上面介绍的日志输出主体流程，可以将 Loguru 配置为标准日志模块的 <code>Handler</code>。业务代码仍然通过标准日志模块打印日志，实际的日志输出通过 Loguru 执行，从而达到日志实现与业务代码隔离的目的。</p><p>这种方式非常类似于 Java 中的 <code>slf4j</code>，也是面向接口编程思想的实践。</p><h2 id=loguru-日志集成>Loguru 日志集成</h2><h3 id=基于字典的日志配置>基于字典的日志配置</h3><p>Python 从 PEP 391 [<a href=https://peps.python.org/pep-0391/ target=_blank rel="external nofollow noopener noreferrer">6</a>] 开始支持基于字典的日志配置，考虑字典是为了提供最大的扩展性，像 <code>JSON</code> 以及 <code>YAML</code> 等格式都可以转换成字典，进而也可以用于进行日志配置。</p><p>为了能使用纯文本完成日志配置，PEP 391 定义了一些特殊解析器。</p><h4 id=python-对象访问解析器>Python 对象访问解析器</h4><p>格式为 <code>ext://xxx.xxx</code>，当需要使用到 Python 系统路径中的对象时使用，最常用的例子是引用标准控制台输出流，以 <code>YAML</code> 格式为例：</p><div class=highlight id=id-6><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>handlers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>console</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>class</span><span class=p>:</span><span class=w> </span><span class=l>logging.StreamHandler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>formatter</span><span class=p>:</span><span class=w> </span><span class=l>brief</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=l>INFO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>stream</span><span class=p>:</span><span class=w> </span><span class=l>ext://sys.stdout</span></span></span></code></pre></td></tr></table></div></div><p>除开 <code>ext://</code> 前缀的其他部分将等效使用 <code>import</code> 导入使用。</p><h4 id=日志配置访问解析器>日志配置访问解析器</h4><p>格式为 <code>cfg://xxx.xxx</code>，当需要引用当前日志配置中的配置节点时使用，支持通过 <code>.</code> 嵌套访问子元素、通过 <code>[0]</code> 访问数组内元素，使用示例如下：</p><div class=highlight id=id-7><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>handlers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>email</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>class</span><span class=p>:</span><span class=w> </span><span class=l>logging.handlers.SMTPHandler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mailhost</span><span class=p>:</span><span class=w> </span><span class=l>localhost</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>fromaddr</span><span class=p>:</span><span class=w> </span><span class=l>my_app@domain.tld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>toaddrs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>support_team@domain.tld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>dev_team@domain.tld</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>subject</span><span class=p>:</span><span class=w> </span><span class=l>Houston, we have a problem.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>custom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>()</span><span class=p>:</span><span class=w> </span><span class=l>my.package.MyHandler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;cfg://handlers.email.mailhost&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>addr</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;cfg://handlers.email.toaddrs[0]&#39;</span></span></span></code></pre></td></tr></table></div></div><h4 id=用户自定义对象>用户自定义对象</h4><p>支持使用类和 <code>callable</code> 对象作为工厂，类工厂使用 <code>class</code> 关键字配置，<code>callable</code> 工厂使用 <code>()</code> 特殊关键字配置。除 <code>formatters</code>、<code>filters</code> 等特殊配置外，同级的其他参数将作为工厂的入参传入。</p><p>类工厂的例子可以参考上一小节的 <code>SMTPHandler</code> 配置，解析时会触发其构造函数调用：<code>SMTPHandler(mailhost='localhost', fromaddr='my_app@domain.tld', toaddrs=...</code>。</p><p><code>callable</code> 工厂的例子如下：</p><div class=highlight id=id-8><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>formatters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>custom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>()</span><span class=p>:</span><span class=w> </span><span class=l>my.package.customFormatterFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>bar</span><span class=p>:</span><span class=w> </span><span class=l>baz</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spam</span><span class=p>:</span><span class=w> </span><span class=m>99.9</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>answer</span><span class=p>:</span><span class=w> </span><span class=m>42</span></span></span></code></pre></td></tr></table></div></div><p>以上配置解析时会执行 <code>my.package.customFormatterFactory(bar='baz', spam=99.9, answer=42)</code>。</p><p>以上几个解析器已经可以覆盖掉大部分的配置场景了。</p><h3 id=loguru-日志处理器实现>Loguru 日志处理器实现</h3><p>可以通过配置 Loguru 拦截器的方式拦截标准日志模块输出[<a href=https://loguru.readthedocs.io/en/stable/overview.html#entirely-compatible-with-standard-logging target=_blank rel="external nofollow noopener noreferrer">7</a>]，流程示意如下图所示：</p><p><img loading=lazy src=/posts/python-loguru-logging/images/loguru-intercept-handler.png srcset="/posts/python-loguru-logging/images/loguru-intercept-handler.png?size=small, /posts/python-loguru-logging/images/loguru-intercept-handler.png?size=medium 1.5x, /posts/python-loguru-logging/images/loguru-intercept-handler.png?size=large 2x" sizes=auto data-title="Loguru Intercept Handler" data-alt="Loguru Intercept Handler" style="--width:1654px;--aspect-ratio:1654 / 448;background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>Loguru 支持通过 <code>logger.configure()</code> 方法完成日志配置，所有配置参数可通过 <code>LoguruInterceptHandler</code> 构造函数获取，而构造函数可以通过标准日志模块字典配置的类工厂引入。</p><h4 id=yaml-配置样例>yaml 配置样例</h4><p>使用类似下面的 YAML 配置初始化标准日志模块，期望将 <code>loguru_config</code> 属性传递给 <code>logger.configure()</code> 完成 loguru 配置，要达到的效果如下：</p><ol><li>通过 <code>loguru_format</code> 配置日志输出格式；</li><li>配置三个日志输出项，分别为 <code>stdout</code>、<code>stderr</code> 以及日志文件 <code>file.log</code>；</li><li>使用 <code>loguru_logging.compact_name_format</code> 函数进行格式化，其作用是压缩日志中的路径，比如 <code>long.module.dir.log</code> 压缩后输出为 <code>l.m.dir.log</code>；</li><li>支持 <code>lambda://</code> 前缀声明 lambda 表达式，达到 <code>stdout</code> 不输出 <code>ERROR</code> 级别的效果；</li><li>日志文件 <code>file.log</code> 每天零点压缩归档，压缩格式为 <code>tar.gz</code>；</li></ol><div class=highlight id=id-9><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># logging.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># https://docs.python.org/3/library/logging.config.html#configuration-dictionary-schema</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>disable_existing_loggers</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>root</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>handlers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>loguru</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=l>INFO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>handlers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>loguru</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>class</span><span class=p>:</span><span class=w> </span><span class=l>loguru_logging.LoguruInterceptHandler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># constructor param starts with loguru_</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loguru_format</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;&lt;green&gt;{time:YYYY-MM-DD HH:mm:ss.SSS}&lt;/green&gt; | &lt;level&gt;{level: &lt;8}&lt;/level&gt; | &lt;cyan&gt;{name}&lt;/cyan&gt;:&lt;cyan&gt;{function}&lt;/cyan&gt;:&lt;cyan&gt;{line}&lt;/cyan&gt; - &lt;level&gt;{message}&lt;/level&gt;&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>loguru_config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># https://loguru.readthedocs.io/en/stable/api/logger.html#loguru._logger.Logger.configure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>handlers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># param: https://loguru.readthedocs.io/en/stable/api/logger.html#loguru._logger.Logger.add</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>sink</span><span class=p>:</span><span class=w> </span><span class=l>ext://sys.stdout</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=l>INFO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>format</span><span class=p>:</span><span class=w> </span><span class=l>ext://loguru_logging.compact_name_format</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>filter</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;lambda://record:record[&#34;level&#34;].no &lt; logging.ERROR&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>sink</span><span class=p>:</span><span class=w> </span><span class=l>ext://sys.stderr</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=l>ERROR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>format</span><span class=p>:</span><span class=w> </span><span class=l>ext://loguru_logging.compact_name_format</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>sink</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;file.log&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>rotation</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;00:00&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>compression</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;tar.gz&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=l>INFO</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>format</span><span class=p>:</span><span class=w> </span><span class=l>ext://meta_repository.loguru_logging.compact_name_format</span></span></span></code></pre></td></tr></table></div></div><p>完整的配置支持可参考基于字典的标准日志模块配置[<a href=https://peps.python.org/pep-0391/ target=_blank rel="external nofollow noopener noreferrer">6</a>]以及 <code>logger.configure()</code> API 文档[<a href=https://loguru.readthedocs.io/en/stable/api/logger.html#loguru._logger.Logger.configure target=_blank rel="external nofollow noopener noreferrer">8</a>]。</p><h4 id=拦截器实现>拦截器实现</h4><p>接下来基于示例 YAML 配置文件的声明，进行拦截器实现，主要包括：</p><ol><li><code>LoguruInterceptHandler</code> 类构造函数接收配置参数，并在构造函数中完成日志配置；</li><li>继承 <code>logging.config.BaseConfigurator</code> 实现 loguru 配置类 <code>LoguruDictConfigurator</code>，以复用路径解析、 <code>ext://</code> 前缀等功能；</li><li>参考 <code>logger.configure()</code> api 文档，在 <code>LoguruDictConfigurator.configure</code> 方法中构造 loguru 配置参数；</li><li>扩展 <code>value_converters</code> 支持 <code>lambda://</code> 前缀表达式；</li><li>实现 <code>compact_name_format</code> 动态格式化函数，对 <code>name</code> 进行压缩；</li></ol><p>具体实现如下：</p><div class=highlight id=id-10><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>inspect</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>logging.config</span> <span class=kn>import</span> <span class=n>BaseConfigurator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>loguru</span> <span class=kn>import</span> <span class=n>logger</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># _global_loguru_format may be changed by LoguruInterceptHandler</span>
</span></span><span class=line><span class=cl><span class=n>_global_loguru_format</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;LOGURU_FORMAT&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&lt;green&gt;{time:YYYY-MM-DD HH:mm:ss.SSS}&lt;/green&gt; | &#34;</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&lt;level&gt;</span><span class=si>{level: &lt;8}</span><span class=s2>&lt;/level&gt; | &#34;</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&lt;cyan&gt;</span><span class=si>{name}</span><span class=s2>&lt;/cyan&gt;:&lt;cyan&gt;</span><span class=si>{function}</span><span class=s2>&lt;/cyan&gt;:&lt;cyan&gt;</span><span class=si>{line}</span><span class=s2>&lt;/cyan&gt; - &lt;level&gt;</span><span class=si>{message}</span><span class=s2>&lt;/level&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>compact_name_format</span><span class=p>(</span><span class=n>record</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; loguru dynamic formatter
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    :param record: log record
</span></span></span><span class=line><span class=cl><span class=s2>    :return:
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>compact_name</span> <span class=o>=</span> <span class=n>compact_path</span><span class=p>(</span><span class=n>record</span><span class=p>[</span><span class=s2>&#34;name&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>format_name</span><span class=p>(</span><span class=k>match</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>match</span><span class=o>.</span><span class=n>group</span><span class=p>()</span><span class=o>.</span><span class=n>format_map</span><span class=p>({</span><span class=s2>&#34;name&#34;</span><span class=p>:</span> <span class=n>compact_name</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;{name(:.*?)?}&#34;</span><span class=p>,</span> <span class=n>format_name</span><span class=p>,</span> <span class=n>_global_loguru_format</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=si>{exception}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>LoguruInterceptHandler</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>Handler</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;intercept standard logging messages toward loguru
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    https://github.com/Delgan/loguru#entirely-compatible-with-standard-logging
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>loguru_config</span><span class=p>:</span> <span class=nb>dict</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span> <span class=n>loguru_format</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>loguru_config</span> <span class=o>=</span> <span class=n>loguru_config</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>loguru_format</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>global</span> <span class=n>_global_loguru_format</span>
</span></span><span class=line><span class=cl>            <span class=n>_global_loguru_format</span> <span class=o>=</span> <span class=n>loguru_format</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>configure_loguru</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>emit</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>record</span><span class=p>:</span> <span class=n>logging</span><span class=o>.</span><span class=n>LogRecord</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Get corresponding Loguru level if it exists.</span>
</span></span><span class=line><span class=cl>        <span class=n>level</span><span class=p>:</span> <span class=nb>str</span> <span class=o>|</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>level</span> <span class=o>=</span> <span class=n>logger</span><span class=o>.</span><span class=n>level</span><span class=p>(</span><span class=n>record</span><span class=o>.</span><span class=n>levelname</span><span class=p>)</span><span class=o>.</span><span class=n>name</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>ValueError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>level</span> <span class=o>=</span> <span class=n>record</span><span class=o>.</span><span class=n>levelno</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Find caller from where originated the logged message.</span>
</span></span><span class=line><span class=cl>        <span class=n>frame</span><span class=p>,</span> <span class=n>depth</span> <span class=o>=</span> <span class=n>inspect</span><span class=o>.</span><span class=n>currentframe</span><span class=p>(),</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=n>frame</span> <span class=ow>and</span> <span class=p>(</span><span class=n>depth</span> <span class=o>==</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>frame</span><span class=o>.</span><span class=n>f_code</span><span class=o>.</span><span class=n>co_filename</span> <span class=o>==</span> <span class=n>logging</span><span class=o>.</span><span class=vm>__file__</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>frame</span> <span class=o>=</span> <span class=n>frame</span><span class=o>.</span><span class=n>f_back</span>
</span></span><span class=line><span class=cl>            <span class=n>depth</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>opt</span><span class=p>(</span><span class=n>depth</span><span class=o>=</span><span class=n>depth</span><span class=p>,</span> <span class=n>exception</span><span class=o>=</span><span class=n>record</span><span class=o>.</span><span class=n>exc_info</span><span class=p>)</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>level</span><span class=p>,</span> <span class=n>record</span><span class=o>.</span><span class=n>getMessage</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>configure_loguru</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>LoguruDictConfigurator</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>loguru_config</span><span class=p>)</span><span class=o>.</span><span class=n>configure</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>LoguruDictConfigurator</span><span class=p>(</span><span class=n>BaseConfigurator</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>value_converters</span> <span class=o>=</span> <span class=n>BaseConfigurator</span><span class=o>.</span><span class=n>value_converters</span> <span class=o>|</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;lambda&#34;</span><span class=p>:</span> <span class=s2>&#34;lambda_convert&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># https://loguru.readthedocs.io/en/stable/api/logger.html#loguru._logger.Logger.configure</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>configure</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>loguru_config</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=n>config</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>config</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># list of dict</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s2>&#34;handlers&#34;</span> <span class=ow>in</span> <span class=n>config</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>handlers_config</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;handlers&#34;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>            <span class=n>handlers</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>handler_dict</span> <span class=ow>in</span> <span class=n>handlers_config</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>_handler</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>configure_handler</span><span class=p>(</span><span class=n>handler_dict</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>handlers</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>_handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>handlers</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>loguru_config</span><span class=p>[</span><span class=s2>&#34;handlers&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>handlers</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># list of dict</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s2>&#34;levels&#34;</span> <span class=ow>in</span> <span class=n>config</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>loguru_config</span><span class=p>[</span><span class=s2>&#34;levels&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>config</span><span class=p>[</span><span class=s2>&#34;levels&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># dict</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s2>&#34;extra&#34;</span> <span class=ow>in</span> <span class=n>config</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>loguru_config</span><span class=p>[</span><span class=s2>&#34;extra&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>config</span><span class=p>[</span><span class=s2>&#34;extra&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># callable</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s2>&#34;patcher&#34;</span> <span class=ow>in</span> <span class=n>config</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>_patcher</span> <span class=o>=</span> <span class=n>config</span><span class=p>[</span><span class=s2>&#34;patcher&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>loguru_config</span><span class=p>[</span><span class=s2>&#34;patcher&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>resolve</span><span class=p>(</span><span class=n>_patcher</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># list of tuple</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s2>&#34;activation&#34;</span> <span class=ow>in</span> <span class=n>config</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>activation_config</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;activation&#34;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>            <span class=n>activations</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>activation_dict</span> <span class=ow>in</span> <span class=n>activation_config</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>_activation</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>configure_activation</span><span class=p>(</span><span class=n>activation_dict</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>activations</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>_activation</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>activations</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>loguru_config</span><span class=p>[</span><span class=s2>&#34;activation&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>activations</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>configure</span><span class=p>(</span><span class=o>**</span><span class=n>loguru_config</span><span class=p>)</span>  <span class=c1># type: ignore</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>configure_handler</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>config</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># https://loguru.readthedocs.io/en/stable/api/logger.html#loguru._logger.Logger.add</span>
</span></span><span class=line><span class=cl>        <span class=n>handler</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>_sink</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s2>&#34;sink&#34;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>handler</span><span class=p>[</span><span class=s2>&#34;sink&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>convert</span><span class=p>(</span><span class=n>_sink</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>_format</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s2>&#34;format&#34;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>_format</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>handler</span><span class=p>[</span><span class=s2>&#34;format&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>convert</span><span class=p>(</span><span class=n>_format</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>handler</span><span class=p>[</span><span class=s2>&#34;format&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>_global_loguru_format</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>_filter</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s2>&#34;filter&#34;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>_filter</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>handler</span><span class=p>[</span><span class=s2>&#34;filter&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>convert</span><span class=p>(</span><span class=n>_filter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># rest config use as it is</span>
</span></span><span class=line><span class=cl>        <span class=n>handler</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>handler</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>configure_activation</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>config</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>tuple</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>config</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s1>&#39;Unable to configure activation, should only have one item per element but got &#39;</span>
</span></span><span class=line><span class=cl>                             <span class=s1>&#39;</span><span class=si>%r</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=n>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>popitem</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>lambda_convert</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Default converter for the lambda:// protocol.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>eval</span><span class=p>(</span><span class=s2>&#34;lambda &#34;</span> <span class=o>+</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>compact_path</span><span class=p>(</span><span class=n>path</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>retain</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;通过压缩路径前缀简化路径输出
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    :param path: 原始路径，如：infrastructure.adapters.socketio.namespaces
</span></span></span><span class=line><span class=cl><span class=s2>    :param retain: 保留层级，默认2
</span></span></span><span class=line><span class=cl><span class=s2>    :return: 前缀缩写后的路径，如：i.a.s.namespaces.teach_namespace
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=n>path</span> <span class=ow>or</span> <span class=n>retain</span> <span class=o>&lt;</span> <span class=mi>1</span> <span class=ow>or</span> <span class=n>path</span><span class=o>.</span><span class=n>count</span><span class=p>(</span><span class=s2>&#34;.&#34;</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>retain</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>path</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>slices</span> <span class=o>=</span> <span class=n>path</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># i.a.s.namespaces.teach_namespace</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s2>&#34;.&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>s</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>slices</span><span class=p>[:</span><span class=o>-</span><span class=n>retain</span><span class=p>]</span> <span class=k>if</span> <span class=n>s</span><span class=p>])</span> <span class=o>+</span> <span class=s2>&#34;.&#34;</span> <span class=o>+</span> <span class=s2>&#34;.&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>slices</span><span class=p>[</span><span class=o>-</span><span class=n>retain</span><span class=p>:])</span></span></span></code></pre></td></tr></table></div></div><h2 id=总结>总结</h2><p>具体实现看起来比较复杂，但实际上只是把复杂的事情做一次，后续简单的事情重复 n 次，所获得的收益还是值得的。</p><p>使用这种配置方式，只需要在项目根目录配置好对应的 <code>logging.yml</code>，然后在项目入口完成日志配置，比如：</p><div class=highlight id=id-11><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging.config</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>yaml</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 初始化日志配置文件</span>
</span></span><span class=line><span class=cl><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;logging.yml&#39;</span><span class=p>,</span> <span class=s2>&#34;r&#34;</span><span class=p>)</span> <span class=k>as</span> <span class=n>conf</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>conf_dict</span> <span class=o>=</span> <span class=n>yaml</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>conf</span><span class=p>,</span> <span class=n>Loader</span><span class=o>=</span><span class=n>yaml</span><span class=o>.</span><span class=n>FullLoader</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>dictConfig</span><span class=p>(</span><span class=n>conf_dict</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>app</span><span class=o>.</span><span class=n>run</span><span class=p>()</span></span></span></code></pre></td></tr></table></div></div><p>其他模块通过标准日志模块打印日志即可，如：</p><div class=highlight id=id-12><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>demo_function</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;This is a standard log but will log by loguru.&#34;</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><h2 id=参考资料>参考资料</h2><p>[1]. <a href=https://docs.python.org/3/library/logging.html target=_blank rel="external nofollow noopener noreferrer">Logging facility for Python, Python Docs</a><br>[2]. <a href=https://peps.python.org/pep-0282/ target=_blank rel="external nofollow noopener noreferrer">PEP 282 – A Logging System</a><br>[3]. <a href=https://docs.python.org/3/howto/logging.html#advanced-logging-tutorial target=_blank rel="external nofollow noopener noreferrer">Advanced Logging Tutorial, Python Docs</a><br>[4]. <a href=https://docs.python.org/3/howto/logging.html#logging-flow target=_blank rel="external nofollow noopener noreferrer">Logging Flow, Python Docs</a><br>[5]. <a href=https://loguru.readthedocs.io/en/stable/overview.html#features target=_blank rel="external nofollow noopener noreferrer">Features of Loguru</a><br>[6]. <a href=https://peps.python.org/pep-0391/ target=_blank rel="external nofollow noopener noreferrer">PEP 391 – Dictionary-Based Configuration For Logging</a><br>[7]. <a href=https://loguru.readthedocs.io/en/stable/overview.html#entirely-compatible-with-standard-logging target=_blank rel="external nofollow noopener noreferrer">loguru compatible with standard logging</a><br>[8]. <a href=https://loguru.readthedocs.io/en/stable/api/logger.html#loguru._logger.Logger.configure target=_blank rel="external nofollow noopener noreferrer">logger.configure() api of Loguru</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2024-01-04 22:04:28">更新于 2024-01-04&nbsp;</span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/python-loguru-logging/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://will4j.github.io/posts/python-loguru-logging/ data-title="Python 工程化：Loguru 日志集成" data-hashtags=Python><i class="fa-brands fa-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://will4j.github.io/posts/python-loguru-logging/ data-title="Python 工程化：Loguru 日志集成"><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/python/ class=post-tag>Python</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/taskfile-the-alternatives-to-makefile/ class=post-nav-item rel=prev title="Makefile 平替：跨平台构建脚本 Taskfile"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>Makefile 平替：跨平台构建脚本 Taskfile</a></div></div><div id=comments><div id=giscus><script src=https://giscus.app/client.js data-repo=will4j/blog-resource data-repo-id=R_kgDOKus4vg data-category="Blog Comments" data-category-id=DIC_kwDOKus4vs4CbCP2 data-mapping=pathname data-strict=0 data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></article></main><footer class=footer><div class=footer-container><div class="footer-line powered order-1">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.120.4">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.2.18-lts.5"><img class=fixit-icon src=/fixit.min.svg alt="FixIt logo">&nbsp;FixIt</a></div><div class="footer-line copyright order-last" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2023 - 2024</span><span class=author itemprop=copyrightHolder>
<a href=/></a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics order-first"><span class=site-time title=网站运行中……><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden=true></i><span class="run-times ms-1">网站运行中……</span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class="variant-numeric d-none">0%</span></div><div class="fixed-button view-comments d-none" role=button aria-label=查看评论><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><a href=https://github.com/will4j title="Visit Me on GitHub" target=_blank rel="external nofollow" class="github-corner left d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css><script src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js defer></script><script src=https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js defer></script><script src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js async defer></script><script src=https://cdn.jsdelivr.net/npm/typeit@8.7.1/dist/index.umd.js defer></script><script src=https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js defer></script><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:10},comment:{enable:!0,expired:!1,giscus:{darkTheme:"dark",lightTheme:"light"}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},data:{"typeit-header-desktop":"程序员水王","typeit-header-title-mobile":"程序员水王"},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/index.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:30,threshold:.3,type:"fuse",useExtendedSearch:!1},siteTime:"2023-11-16T07:40:29+08:00",typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"typeit-header-desktop":["typeit-header-desktop"],"typeit-header-title-mobile":["typeit-header-title-mobile"]},duration:-1,loop:!1,speed:100}}</script><script src=/js/theme.min.js defer></script></body></html>