<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>Python 装饰器详解 - 水王笔记</title><meta name=author content="水王">
<meta name=author-link content="https://github.com/will4j"><meta name=description content="从函数式编程和语法糖角度详解 Python 装饰器原理。"><meta name=keywords content="python"><meta itemprop=name content="Python 装饰器详解"><meta itemprop=description content="从函数式编程和语法糖角度详解 Python 装饰器原理。"><meta itemprop=datePublished content="2023-11-14T14:05:42+08:00"><meta itemprop=dateModified content="2023-11-17T14:56:11+08:00"><meta itemprop=wordCount content="7041"><meta itemprop=keywords content="python,"><meta property="og:title" content="Python 装饰器详解"><meta property="og:description" content="从函数式编程和语法糖角度详解 Python 装饰器原理。"><meta property="og:type" content="article"><meta property="og:url" content="https://will4j.github.io/posts/explain-python-decorator-in-detail/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-11-14T14:05:42+08:00"><meta property="article:modified_time" content="2023-11-17T14:56:11+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Python 装饰器详解"><meta name=twitter:description content="从函数式编程和语法糖角度详解 Python 装饰器原理。"><meta name=application-name content="水王笔记"><meta name=apple-mobile-web-app-title content="水王笔记"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=/favicon.svg><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://will4j.github.io/posts/explain-python-decorator-in-detail/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Python 装饰器详解","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/will4j.github.io\/posts\/explain-python-decorator-in-detail\/"},"genre":"posts","keywords":"python","wordcount":7041,"url":"https:\/\/will4j.github.io\/posts\/explain-python-decorator-in-detail\/","datePublished":"2023-11-14T14:05:42+08:00","dateModified":"2023-11-17T14:56:11+08:00","license":"by 水王","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"水王"},"description":"从函数式编程和语法糖角度详解 Python 装饰器原理。"}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=水王笔记><span class=header-title-pre><i class="fa fa-code"></i></span><span id=typeit-header-desktop class=typeit></span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/><i class="fa-solid fa-home fa-fw fa-sm" aria-hidden=true></i> 首页</a></li><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th-list fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=水王笔记><span class=header-title-pre><i class="fa fa-code"></i></span><span id=typeit-header-title-mobile class=typeit></span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/><i class="fa-solid fa-home fa-fw fa-sm" aria-hidden=true></i> 首页</a></li><li class=menu-item><a class=menu-link href=/posts/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 文章</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-th-list fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><nav aria-label=breadcrumb class=breadcrumb-container><ol class=breadcrumb><li class=breadcrumb-item><a href=/posts/ title=Posts>Posts</a></li><li class="breadcrumb-item active" aria-current=page>Python 装饰器详解</li></ol></nav><main class=container><aside class=toc id=toc-auto><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>Python 装饰器详解</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/will4j title=作者 target=_blank rel="external nofollow noopener noreferrer author" class=author><img loading=lazy src=/img/avatar.png data-title=水王 data-alt=水王 class=avatar style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'>&nbsp;水王</a></span>
<span class=post-category>收录于 <a href=/categories/python-lang/><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> Python 语言</a></span></div><div class=post-meta-line><span title="发布于 2023-11-14 14:05:42"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden=true></i><time datetime=2023-11-14>2023-11-14</time></span>&nbsp;<span title="更新于 2023-11-17 14:56:11"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden=true></i><time datetime=2023-11-17>2023-11-17</time></span>&nbsp;<span title="7041 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 7100 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 15 分钟</span>&nbsp;<span id=busuanzi_container_page_pv class="busuanzi_visitors comment-visitors" data-flag-title="Python 装饰器详解">
<i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_page_pv>-</span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ol><li><a href=#问题场景>问题场景</a></li><li><a href=#理解装饰器>理解装饰器</a><ol><li><a href=#头等函数>头等函数</a><ol><li><a href=#函数作为实参传递>函数作为实参传递</a></li><li><a href=#嵌套函数>嵌套函数</a></li><li><a href=#函数作为返回值>函数作为返回值</a></li><li><a href=#重新认识装饰器>重新认识装饰器</a></li></ol></li><li><a href=#装饰器语法糖>装饰器语法糖</a></li><li><a href=#functoolswraps-的作用>functools.wraps 的作用</a></li><li><a href=#装饰器小结>装饰器小结</a></li></ol></li><li><a href=#函数装饰器进阶>函数装饰器进阶</a><ol><li><a href=#有参装饰器>有参装饰器</a></li><li><a href=#装饰器可选参数>装饰器可选参数</a></li><li><a href=#装饰器别名>装饰器别名</a></li><li><a href=#类装饰器>类装饰器</a></li></ol></li><li><a href=#基于类实现装饰器>基于类实现装饰器</a><ol><li><a href=#类的__call__方法>类的<code>__call__</code>方法</a></li><li><a href=#基于类的装饰器实现>基于类的装饰器实现</a></li><li><a href=#小心状态化>小心状态化</a></li></ol></li><li><a href=#总结>总结</a></li><li><a href=#后记>后记</a><ol><li><a href=#设计思考>设计思考</a></li><li><a href=#编程考古>编程考古</a></li></ol></li><li><a href=#参考资料>参考资料</a></li></ol></nav></div></div><div class=content id=content><blockquote><p>工欲善其事，必先利其器。—《论语·卫灵公》</p></blockquote><p>本文从装饰器使用到的函数式编程特性入手，讨论了无参装饰器、有参装饰器以及类装饰器三种语法糖规则下装饰器的实现，另外扩展讨论了基于类的实现方式。</p><p>总结部分提供了一些实用装饰器的参考资料，后记部分是作者对设计的一些思考，以及行文过程中发现的一些历史事件、奇闻轶事。</p><p>希望这篇文章可以帮助你更好地理解装饰器，全文思维导图如下：</p><p><img loading=lazy src=/posts/explain-python-decorator-in-detail/images/mind-map.png srcset="/posts/explain-python-decorator-in-detail/images/mind-map.png?size=small, /posts/explain-python-decorator-in-detail/images/mind-map.png?size=medium 1.5x, /posts/explain-python-decorator-in-detail/images/mind-map.png?size=large 2x" sizes=auto data-title="Python 装饰器详解" data-alt="Python 装饰器详解" style="--width:1856px;--aspect-ratio:1856 / 1996;background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><h2 id=问题场景>问题场景</h2><p>我想创建一个通用的日志装饰器，其作用是在函数调用之后记录参数和返回值，于是在Google一番之后，写下了下面的代码：</p><div class=highlight id=id-1><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>functools</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>log</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nd>@functools.wraps</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;function </span><span class=si>%s</span><span class=s2> called with args=</span><span class=si>%s</span><span class=s2> kwargs=</span><span class=si>%s</span><span class=s2> and result=</span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                    <span class=n>func</span><span class=o>.</span><span class=vm>__name__</span><span class=p>,</span> <span class=n>args</span><span class=p>,</span> <span class=n>kwargs</span><span class=p>,</span> <span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>wrapper</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@log</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>greeting</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>say</span><span class=o>=</span><span class=s2>&#34;Hello&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>say</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>!&#34;</span></span></span></code></pre></td></tr></table></div></div><p>现在执行<code>greeting</code>函数会产生如下输出：</p><div class=highlight id=id-2><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>greeting</span><span class=p>(</span><span class=s2>&#34;World&#34;</span><span class=p>,</span> <span class=n>say</span><span class=o>=</span><span class=s2>&#34;Hi&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>INFO</span><span class=p>:</span><span class=n>__main__</span><span class=p>:</span><span class=n>function</span> <span class=n>greeting</span> <span class=n>called</span> <span class=k>with</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;World&#39;</span><span class=p>,)</span> <span class=n>kwargs</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;say&#39;</span><span class=p>:</span> <span class=s1>&#39;Hi&#39;</span><span class=p>}</span> <span class=ow>and</span> <span class=n>result</span><span class=o>=</span><span class=n>Hi</span> <span class=n>World</span><span class=err>!</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;Hi World!&#39;</span></span></span></code></pre></td></tr></table></div></div><p>看起来还不错？它足够通用，因为使用了<code>*args</code>和<code>**kwargs</code>，任何不同签名的其他函数都能通过<code>log</code>装饰器打印日志。但也存在一些问题，比如<code>@functools.wraps</code>在这里起什么作用？如果需要自定义不同的日志级别该怎么办？如果要自定义<code>logger</code>名称又该怎么办？</p><p>我需要更深入了解装饰器，才能回答上面这些问题。</p><h2 id=理解装饰器>理解装饰器</h2><p>也许你知道Java中的注解(<code>@Annotation</code>)是通过反射和动态代理来实现的，那么Python中的装饰器呢？可以看到，<code>log</code>装饰器本身是一个函数，如果把<code>greeting</code>函数上的<code>log</code>装饰器去掉，直接像下面这样调用<code>log</code>函数，可以得到跟使用装饰器一样的效果：</p><div class=highlight id=id-3><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>log</span><span class=p>(</span><span class=n>greeting</span><span class=p>)(</span><span class=s2>&#34;World&#34;</span><span class=p>,</span> <span class=n>say</span><span class=o>=</span><span class=s2>&#34;Hi&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>INFO</span><span class=p>:</span><span class=n>__main__</span><span class=p>:</span><span class=n>function</span> <span class=n>greeting</span> <span class=n>called</span> <span class=k>with</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;World&#39;</span><span class=p>,)</span> <span class=n>kwargs</span><span class=o>=</span><span class=p>{</span><span class=s1>&#39;say&#39;</span><span class=p>:</span> <span class=s1>&#39;Hi&#39;</span><span class=p>}</span> <span class=ow>and</span> <span class=n>result</span><span class=o>=</span><span class=n>Hi</span> <span class=n>World</span><span class=err>!</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;Hi World!&#39;</span></span></span></code></pre></td></tr></table></div></div><p>把函数作为参数？简单直接，Python装饰器也是这么做的，即在目标函数外部再包裹一层函数，并在目标函数调用前后动态增加行为，很典型的装饰器模式。那么，为什么能如此直接的做到函数作为参数传递及函数嵌套呢？先来了解一下头等函数。</p><h3 id=头等函数>头等函数</h3><p>头等函数[<a href=https://zh.wikipedia.org/wiki/%E5%A4%B4%E7%AD%89%E5%87%BD%E6%95%B0 target=_blank rel="external nofollow noopener noreferrer">1</a>]，其实我更喜欢称之为<em>一等公民</em>函数，即在编程语言中，函数作为一等公民，享有完全行为能力，能进行编程语言实体所具备的所有操作，包括但不限于：</p><ul><li>函数作为实参传递</li><li>函数作为返回值</li><li>函数赋值给变量</li><li>嵌套函数、匿名函数、闭包等</li></ul><p>分别来看下装饰器使用到的几个特性：函数作为实参传递、嵌套函数以及函数作为返回值。</p><h4 id=函数作为实参传递>函数作为实参传递</h4><p>典型的例子是Python内置函数<code>map</code>，其第一个参数为转换函数，<code>map</code>函数执行时会遍历列表，以列表元素作为入参调用转换函数，然后将转换函数返回值组成新的列表返回。比如下面的代码，可以完成对列表中元素求平方的转换。</p><div class=highlight id=id-4><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>square</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>x</span> <span class=o>**</span> <span class=mi>2</span></span></span></code></pre></td></tr></table></div></div><div class=highlight id=id-5><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>map</span><span class=p>(</span><span class=n>square</span><span class=p>,</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=nb>map</span> <span class=nb>object</span> <span class=n>at</span> <span class=mh>0x102783520</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nb>list</span><span class=p>(</span><span class=nb>map</span><span class=p>(</span><span class=n>square</span><span class=p>,</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>9</span><span class=p>,</span> <span class=mi>16</span><span class=p>]</span></span></span></code></pre></td></tr></table></div></div><h4 id=嵌套函数>嵌套函数</h4><p>即在函数内部嵌套声明函数，被嵌套的函数也可以称为内部函数。外部函数的局部变量（包括形参）对内部函数可见。</p><p>下面的代码用特定字符打印一个三行的三角形，内部函数<code>print_line</code>接收行参数<code>n</code>，并在函数体中直接使用了外部函数的<code>char</code>变量。</p><div class=highlight id=id-6><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>print_triangle</span><span class=p>(</span><span class=n>char</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>print_line</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(((</span><span class=mi>2</span> <span class=o>*</span> <span class=n>n</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=n>char</span><span class=p>)</span><span class=o>.</span><span class=n>center</span><span class=p>(</span><span class=mi>5</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>print_line</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>print_line</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>print_line</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><div class=highlight id=id-7><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>print_triangle</span><span class=p>(</span><span class=s2>&#34;*&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span>
</span></span><span class=line><span class=cl> <span class=o>***</span>
</span></span><span class=line><span class=cl><span class=o>*****</span></span></span></code></pre></td></tr></table></div></div><h4 id=函数作为返回值>函数作为返回值</h4><p>函数返回值可以是另外一个函数。</p><p>在下面的代码中，<code>times_n</code>函数返回<code>product</code>函数，后者根据参数<code>n</code>不同，将返回不同的函数版本，因此<code>times_n(3)</code>将返回乘以3的<code>product</code>函数<code>times_3</code>，调用<code>times_3(5)</code>计算将得到结果15。</p><div class=highlight id=id-8><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>times_n</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>product</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>x</span> <span class=o>*</span> <span class=n>n</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>product</span></span></span></code></pre></td></tr></table></div></div><div class=highlight id=id-9><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>times_3</span> <span class=o>=</span> <span class=n>times_n</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>times_3</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>function</span> <span class=n>times_n</span><span class=o>.&lt;</span><span class=nb>locals</span><span class=o>&gt;.</span><span class=n>product</span> <span class=n>at</span> <span class=mh>0x1027b96c0</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>times_3</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>15</span></span></span></code></pre></td></tr></table></div></div><h4 id=重新认识装饰器>重新认识装饰器</h4><p>函数在Python中被视为一等公民，对头等函数有了初步了解之后，可以从函数的角度重新认识一下<code>log</code>装饰器，关注其中用到的头等函数特性：<code>func</code>函数作为入参传递，内部函数<code>wrapper</code>作为返回值：</p><div class=highlight id=id-10><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>log</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>  <span class=c1># 1. func函数作为入参传递</span>
</span></span><span class=line><span class=cl>    <span class=nd>@functools.wraps</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>  <span class=c1># 2. 嵌套函数(内部函数)wrapper</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;function </span><span class=si>%s</span><span class=s2> called with args=</span><span class=si>%s</span><span class=s2> kwargs=</span><span class=si>%s</span><span class=s2> and result=</span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                    <span class=n>func</span><span class=o>.</span><span class=vm>__name__</span><span class=p>,</span> <span class=n>args</span><span class=p>,</span> <span class=n>kwargs</span><span class=p>,</span> <span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>wrapper</span>  <span class=c1># 3. 函数作为返回值</span></span></span></code></pre></td></tr></table></div></div><p>可以把<code>log(greeting)("World", say="Hi")</code>进行分解：</p><div class=highlight id=id-11><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>greeting</span> <span class=o>=</span> <span class=n>log</span><span class=p>(</span><span class=n>greeting</span><span class=p>)</span> <span class=c1># 头等函数log的返回值是内部函数wrapper，</span>
</span></span><span class=line><span class=cl>												 <span class=c1># 将wrapper赋值给变量greeting，两者都是函数类型</span>
</span></span><span class=line><span class=cl><span class=n>greeting</span><span class=p>(</span><span class=s2>&#34;World&#34;</span><span class=p>,</span> <span class=n>say</span><span class=o>=</span><span class=s2>&#34;Hi&#34;</span><span class=p>)</span> <span class=c1># 使用greeting变量执行，实际调用的是wrapper函数</span></span></span></code></pre></td></tr></table></div></div><p>像上面这样分解后，<code>greeting("World", say="Hi")</code>调用已经不是原<code>greeting</code>函数，实际执行的是内部函数<code>wrapper</code>，因而可以在<code>wrapper</code>中动态新增行为，即在函数调用后输出日志。</p><h3 id=装饰器语法糖>装饰器语法糖</h3><p>从函数的角度重新认识装饰器后，我们知道显式调用<code>log(greeting)("World", say="Hi")</code>已经可以达到装饰器的效果，也清楚了调用的过程和原理，那么<code>@log</code>的使用方式有什么不同呢？</p><p>其实<code>@</code>操作符只是一个语法糖，在PEP 318[<a href=https://peps.python.org/pep-0318/ target=_blank rel="external nofollow noopener noreferrer">2</a>]中有清晰的描述，其达到的效果如下，即使得：</p><div class=highlight id=id-12><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@dec2</span>
</span></span><span class=line><span class=cl><span class=nd>@dec1</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>func</span><span class=p>(</span><span class=n>arg1</span><span class=p>,</span> <span class=n>arg2</span><span class=p>,</span> <span class=o>...</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span></span></span></code></pre></td></tr></table></div></div><p>等价于：</p><div class=highlight id=id-13><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>func</span><span class=p>(</span><span class=n>arg1</span><span class=p>,</span> <span class=n>arg2</span><span class=p>,</span> <span class=o>...</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl><span class=n>func</span> <span class=o>=</span> <span class=n>dec2</span><span class=p>(</span><span class=n>dec1</span><span class=p>(</span><span class=n>func</span><span class=p>))</span></span></span></code></pre></td></tr></table></div></div><p>同时支持有参装饰器（在函数装饰器进阶一节中将详细讨论有参装饰器），使得：</p><div class=highlight id=id-14><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@decomaker</span><span class=p>(</span><span class=n>argA</span><span class=p>,</span> <span class=n>argB</span><span class=p>,</span> <span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>func</span><span class=p>(</span><span class=n>arg1</span><span class=p>,</span> <span class=n>arg2</span><span class=p>,</span> <span class=o>...</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span></span></span></code></pre></td></tr></table></div></div><p>等价于：</p><div class=highlight id=id-15><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>func</span><span class=p>(</span><span class=n>arg1</span><span class=p>,</span> <span class=n>arg2</span><span class=p>,</span> <span class=o>...</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl><span class=n>func</span> <span class=o>=</span> <span class=n>decomaker</span><span class=p>(</span><span class=n>argA</span><span class=p>,</span> <span class=n>argB</span><span class=p>,</span> <span class=o>...</span><span class=p>)(</span><span class=n>func</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><h3 id=functoolswraps-的作用>functools.wraps 的作用</h3><p>再来看下<code>@functools.wraps</code>的作用。</p><p>如果去掉<code>log</code>装饰器中内部函数<code>wrapper</code>上的<code>@functools.wraps(func)</code>，查看<code>greeting</code>函数对象，会发现它其实是装饰器内部的<code>wrapper</code>函数，这符合之前对装饰器原理的理解。</p><div class=highlight id=id-16><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>log</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># 移除 @functools.wraps(func)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=nd>@log</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>greeting</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>say</span><span class=o>=</span><span class=s2>&#34;Hello&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span></span></span></code></pre></td></tr></table></div></div><div class=highlight id=id-17><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>greeting</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>function</span> <span class=n>log</span><span class=o>.&lt;</span><span class=nb>locals</span><span class=o>&gt;.</span><span class=n>wrapper</span> <span class=n>at</span> <span class=mh>0x10459e2a0</span><span class=o>&gt;</span></span></span></code></pre></td></tr></table></div></div><p>在<code>wrapper</code>上加上<code>@functools.wraps(func)</code>后，再查看<code>greeting</code>函数对象，发现它仍然是<code>greeting</code>函数：</p><div class=highlight id=id-18><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>log</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nd>@functools.wraps</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>  <span class=c1># 保留 wraps</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=nd>@log</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>greeting</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>say</span><span class=o>=</span><span class=s2>&#34;Hello&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span></span></span></code></pre></td></tr></table></div></div><div class=highlight id=id-19><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>greeting</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>function</span> <span class=n>greeting</span> <span class=n>at</span> <span class=mh>0x10459f4c0</span><span class=o>&gt;</span></span></span></code></pre></td></tr></table></div></div><p>查看<code>@functools.wraps</code>的源码发现，它的作用是将<code>func</code>函数的部分元数据信息复制给<code>wrapper</code>函数，使其伪装成<code>func</code>，这些元数据[<a href="https://docs.python.org/3/reference/datamodel.html?highlight=__doc__#user-defined-functions" target=_blank rel="external nofollow noopener noreferrer">3</a>]包括：函数名称（<code>__name__</code>）、函数注释（<code>__doc__</code>）以及函数模块路径（<code>__module__</code>）等，足够应付大部分场景。</p><p>此外，还可以通过<code>__wrapped__</code>属性访问被装饰函数的真身：</p><div class=highlight id=id-20><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>greeting</span><span class=o>.</span><span class=n>__wrapped__</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>function</span> <span class=n>greeting</span> <span class=n>at</span> <span class=mh>0x1079e2a20</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>greeting</span><span class=o>.</span><span class=n>__wrapped__</span><span class=p>(</span><span class=s2>&#34;World&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 这里并没有打印日志，说明确实调用的是原始greeting函数</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;Hello World!&#39;</span></span></span></code></pre></td></tr></table></div></div><h3 id=装饰器小结>装饰器小结</h3><p>装饰器通过<code>@</code>语法糖，使用<code>wrapper</code>函数包裹并通过<code>@functools.wraps</code>伪装成目标函数<code>func</code>，从而达到增强目标函数功能的目的。使用装饰器后，实际调用的是装饰器内的<code>wrapper</code>函数，而不再是<code>func</code>函数自身，简单示意如下图：</p><p><img loading=lazy src=/posts/explain-python-decorator-in-detail/images/decorator-flow.png srcset="/posts/explain-python-decorator-in-detail/images/decorator-flow.png?size=small, /posts/explain-python-decorator-in-detail/images/decorator-flow.png?size=medium 1.5x, /posts/explain-python-decorator-in-detail/images/decorator-flow.png?size=large 2x" sizes=auto data-title=装饰器小结 data-alt=装饰器小结 style="--width:1149px;--aspect-ratio:1149 / 263;background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></p><p>在开头提到的三个问题中，我们已经解答了第一个问题，即<code>@functools.wraps</code>的作用。接下来看下如何支持日志级别以及<code>logger</code>名称，这需要进阶的装饰器用法。</p><h2 id=函数装饰器进阶>函数装饰器进阶</h2><h3 id=有参装饰器>有参装饰器</h3><p>根据PEP 318[<a href=https://peps.python.org/pep-0318/ target=_blank rel="external nofollow noopener noreferrer">2</a>]对<code>@</code>操作符语法糖的说明（可以回顾一下<a href=#%e8%a3%85%e9%a5%b0%e5%99%a8%e8%af%ad%e6%b3%95%e7%b3%96>装饰器语法糖</a>一节的内容），如果给log装饰器添加日志级别参数，其效果应该如下：</p><div class=highlight id=id-21><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@log</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>greeting</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>say</span><span class=o>=</span><span class=s2>&#34;Hello&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=c1># 那么</span>
</span></span><span class=line><span class=cl><span class=n>greeting</span><span class=p>(</span><span class=s2>&#34;World&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 应该等价于</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)(</span><span class=n>greeting</span><span class=p>)(</span><span class=s2>&#34;World&#34;</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>有点太绕了，把中间过程拆解出来再看下：</p><div class=highlight id=id-22><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 第一步接收参数，返回可访问参数的闭包函数</span>
</span></span><span class=line><span class=cl><span class=n>decorator</span> <span class=o>=</span> <span class=n>log</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 用闭包函数作为新的装饰器对greeting函数进行包装</span>
</span></span><span class=line><span class=cl><span class=n>greeting</span> <span class=o>=</span> <span class=n>decorator</span><span class=p>(</span><span class=n>greeting</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 调用包装过后装饰器函数</span>
</span></span><span class=line><span class=cl><span class=n>greeting</span><span class=p>(</span><span class=s2>&#34;World&#34;</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>可以看到，相比无参装饰器，有参装饰器引入了一个中间层，负责返回可访问入参的闭包函数，之后这个闭包函数就可以当做无参装饰器来使用。接下来使用这种方式重新实现<code>log</code>装饰器以支持自定义日志级别：</p><div class=highlight id=id-23><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>functools</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>log</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>decorator</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nd>@functools.wraps</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>level</span><span class=p>,</span> <span class=s2>&#34;function </span><span class=si>%s</span><span class=s2> called with args=</span><span class=si>%s</span><span class=s2> kwargs=</span><span class=si>%s</span><span class=s2> and result=</span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                       <span class=n>func</span><span class=o>.</span><span class=vm>__name__</span><span class=p>,</span> <span class=n>args</span><span class=p>,</span> <span class=n>kwargs</span><span class=p>,</span> <span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>wrapper</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>decorator</span></span></span></code></pre></td></tr></table></div></div><div class=highlight id=id-24><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nd>@log</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>WARNING</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span> <span class=k>def</span> <span class=nf>greeting</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>say</span><span class=o>=</span><span class=s2>&#34;Hello&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>say</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>!&#34;</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>greeting</span><span class=p>(</span><span class=s2>&#34;World&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>WARNING</span><span class=p>:</span><span class=n>__main__</span><span class=p>:</span><span class=n>function</span> <span class=n>greeting</span> <span class=n>called</span> <span class=k>with</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;World&#39;</span><span class=p>,)</span> <span class=n>kwargs</span><span class=o>=</span><span class=p>{}</span> <span class=ow>and</span> <span class=n>result</span><span class=o>=</span><span class=n>Hello</span> <span class=n>World</span><span class=err>!</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;Hello World!&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nd>@log</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>...</span> <span class=k>def</span> <span class=nf>greeting</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>say</span><span class=o>=</span><span class=s2>&#34;Hello&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>say</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>!&#34;</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>greeting</span><span class=p>(</span><span class=s2>&#34;World&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>INFO</span><span class=p>:</span><span class=n>__main__</span><span class=p>:</span><span class=n>function</span> <span class=n>greeting</span> <span class=n>called</span> <span class=k>with</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;World&#39;</span><span class=p>,)</span> <span class=n>kwargs</span><span class=o>=</span><span class=p>{}</span> <span class=ow>and</span> <span class=n>result</span><span class=o>=</span><span class=n>Hello</span> <span class=n>World</span><span class=err>!</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;Hello World!&#39;</span></span></span></code></pre></td></tr></table></div></div><p>到目前为止效果都很理想✌️。不过不知你有没有注意到，在使用默认参数时，装饰器写法是带空括号的<code>@log()</code>，从装饰器语法糖的角度来看，这个空括号还不能去掉，不然的话包裹目标函数的会是中间层的<code>decorator</code>，而不是最终期望的<code>wrapper</code>，来验证一下：</p><div class=highlight id=id-25><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nd>@log</span>
</span></span><span class=line><span class=cl><span class=o>...</span> <span class=k>def</span> <span class=nf>greeting</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>say</span><span class=o>=</span><span class=s2>&#34;Hello&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>say</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>!&#34;</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>greeting</span><span class=p>(</span><span class=s2>&#34;World&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&lt;</span><span class=n>function</span> <span class=n>log</span><span class=o>.&lt;</span><span class=nb>locals</span><span class=o>&gt;.</span><span class=n>decorator</span><span class=o>.&lt;</span><span class=nb>locals</span><span class=o>&gt;.</span><span class=n>wrapper</span> <span class=n>at</span> <span class=mh>0x107a95c60</span><span class=o>&gt;</span></span></span></code></pre></td></tr></table></div></div><p>果然如此，这时候调用<code>greeting</code>实际上执行的是<code>decorator</code>函数，所以返回值是<code>wrapper</code>。</p><h3 id=装饰器可选参数>装饰器可选参数</h3><p>那么，对于有参装饰器是否能支持不带括号使用呢？这样能使装饰器更加灵活，也能避免因括号遗漏导致编码错误。再次回顾装饰器语法糖，实际期望达到的效果应该如下：</p><div class=highlight id=id-26><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@log</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>greeting</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>say</span><span class=o>=</span><span class=s2>&#34;Hello&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=c1># 使得</span>
</span></span><span class=line><span class=cl><span class=n>greeting</span><span class=p>(</span><span class=s2>&#34;World&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 等价于</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=p>(</span><span class=n>greeting</span><span class=p>)(</span><span class=s2>&#34;World&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@log</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>greeting</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>say</span><span class=o>=</span><span class=s2>&#34;Hello&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=c1># 使得</span>
</span></span><span class=line><span class=cl><span class=n>greeting</span><span class=p>(</span><span class=s2>&#34;World&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 等价于</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)(</span><span class=n>greeting</span><span class=p>)(</span><span class=s2>&#34;World&#34;</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>即装饰器需要同时支持有参和无参两种情况，接下来对<code>log</code>装饰器进行改造：</p><div class=highlight id=id-27><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>functools</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>log</span><span class=p>(</span><span class=n>_func</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span> <span class=o>*</span><span class=p>,</span> <span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>decorator</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nd>@functools.wraps</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>logger</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>level</span><span class=p>,</span> <span class=s2>&#34;function </span><span class=si>%s</span><span class=s2> called with args=</span><span class=si>%s</span><span class=s2> kwargs=</span><span class=si>%s</span><span class=s2> and result=</span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                       <span class=n>func</span><span class=o>.</span><span class=vm>__name__</span><span class=p>,</span> <span class=n>args</span><span class=p>,</span> <span class=n>kwargs</span><span class=p>,</span> <span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>wrapper</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>_func</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>decorator</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>decorator</span><span class=p>(</span><span class=n>_func</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>实际效果验证：</p><div class=highlight id=id-28><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nd>@log</span>
</span></span><span class=line><span class=cl><span class=o>...</span> <span class=k>def</span> <span class=nf>greeting</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>say</span><span class=o>=</span><span class=s2>&#34;Hello&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>say</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>!&#34;</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>greeting</span><span class=p>(</span><span class=s2>&#34;World&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>INFO</span><span class=p>:</span><span class=n>__main__</span><span class=p>:</span><span class=n>function</span> <span class=n>greeting</span> <span class=n>called</span> <span class=k>with</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;World&#39;</span><span class=p>,)</span> <span class=n>kwargs</span><span class=o>=</span><span class=p>{}</span> <span class=ow>and</span> <span class=n>result</span><span class=o>=</span><span class=n>Hello</span> <span class=n>World</span><span class=err>!</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;Hello World!&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nd>@log</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>WARNING</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span> <span class=k>def</span> <span class=nf>greeting</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>say</span><span class=o>=</span><span class=s2>&#34;Hello&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>say</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>!&#34;</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>greeting</span><span class=p>(</span><span class=s2>&#34;World&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>WARNING</span><span class=p>:</span><span class=n>__main__</span><span class=p>:</span><span class=n>function</span> <span class=n>greeting</span> <span class=n>called</span> <span class=k>with</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;World&#39;</span><span class=p>,)</span> <span class=n>kwargs</span><span class=o>=</span><span class=p>{}</span> <span class=ow>and</span> <span class=n>result</span><span class=o>=</span><span class=n>Hello</span> <span class=n>World</span><span class=err>!</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;Hello World!&#39;</span></span></span></code></pre></td></tr></table></div></div><p>改造之后的<code>log</code>装饰器增加了<code>_func</code>参数，总结来说，当<code>_func</code>为空时，<code>log</code>应该是有参装饰器，否则应该是无参装饰器。同样的逻辑可以使用<code>partial</code>[<a href=https://docs.python.org/3/library/functools.html#functools.partial target=_blank rel="external nofollow noopener noreferrer">4</a>] [<a href=https://docs.python.org/3/library/functools.html#partial-objects target=_blank rel="external nofollow noopener noreferrer">5</a>]重新实现[<a href=https://python3-cookbook.readthedocs.io/zh-cn/latest/c09/p06_define_decorator_that_takes_optional_argument.html target=_blank rel="external nofollow noopener noreferrer">6</a>]，让代码看起来更直观，同时提取日志名称和日志模板参数，使<code>log</code>装饰器更加通用，最终结果如下：</p><div class=highlight id=id-29><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>functools</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>log</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>func</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>name</span><span class=o>=</span><span class=vm>__name__</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>fmt</span><span class=o>=</span><span class=s2>&#34;function </span><span class=si>%s</span><span class=s2> called with args=</span><span class=si>%s</span><span class=s2> kwargs=</span><span class=si>%s</span><span class=s2> and result=</span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>func</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>functools</span><span class=o>.</span><span class=n>partial</span><span class=p>(</span><span class=n>log</span><span class=p>,</span> <span class=n>level</span><span class=o>=</span><span class=n>level</span><span class=p>,</span> <span class=n>fmt</span><span class=o>=</span><span class=n>fmt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 将logger获取放到wrapper外部，只会在装饰器解析时执行一次，避免每次函数调用都执行</span>
</span></span><span class=line><span class=cl>    <span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@functools.wraps</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>logger</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=n>level</span><span class=p>,</span> <span class=n>fmt</span><span class=p>,</span> <span class=n>func</span><span class=o>.</span><span class=vm>__name__</span><span class=p>,</span> <span class=n>args</span><span class=p>,</span> <span class=n>kwargs</span><span class=p>,</span> <span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>wrapper</span></span></span></code></pre></td></tr></table></div></div><p>至此，<code>log</code>装饰器已经基本完善，开头提出来的日志级别和<code>logger</code>名称的问题也得到了解决，不要停下来，跟我一起继续向前探索。</p><h3 id=装饰器别名>装饰器别名</h3><p>有时候，有参装饰器的某几个参数会在多个场景中重复使用，使代码显得冗余且难以维护，这时可以使用<code>partial</code>为装饰器添加别名。还是以<code>log</code>为例，试下通过别名来自定义日志模板：</p><div class=highlight id=id-30><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 装饰器别名，自定义日志模板</span>
</span></span><span class=line><span class=cl><span class=n>my_log</span> <span class=o>=</span> <span class=n>functools</span><span class=o>.</span><span class=n>partial</span><span class=p>(</span><span class=n>log</span><span class=p>,</span> <span class=n>fmt</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>%s</span><span class=s2> executed, args: </span><span class=si>%s</span><span class=s2> kwargs: </span><span class=si>%s</span><span class=s2> result: </span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@my_log</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>greeting</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>say</span><span class=o>=</span><span class=s2>&#34;Hello&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>say</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>!&#34;</span></span></span></code></pre></td></tr></table></div></div><div class=highlight id=id-31><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>greeting</span><span class=p>(</span><span class=s2>&#34;World&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>INFO</span><span class=p>:</span><span class=n>__main__</span><span class=p>:</span><span class=n>greeting</span> <span class=n>executed</span><span class=p>,</span> <span class=n>args</span><span class=p>:</span> <span class=p>(</span><span class=s1>&#39;World&#39;</span><span class=p>,)</span> <span class=n>kwargs</span><span class=p>:</span> <span class=p>{}</span> <span class=n>result</span><span class=p>:</span> <span class=n>Hello</span> <span class=n>World</span><span class=err>!</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;Hello World!&#39;</span></span></span></code></pre></td></tr></table></div></div><p>函数别名可以快捷方便地做到特定签名的复用，尤其在装饰器以及第三方引入函数的使用上，可以有效消除重复的传参逻辑。</p><h3 id=类装饰器>类装饰器</h3><p>到目前为止，装饰器涉及的参与对象都是函数，接下来加入类的场景，装饰器作用在类上有两种方式：一种是装饰类方法，这种方式其实与装饰函数相同；另一种是装饰类声明，其实现由PEP 3129[<a href=https://peps.python.org/pep-3129/ target=_blank rel="external nofollow noopener noreferrer">7</a>]定义，语法糖效果如下：</p><div class=highlight id=id-32><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nd>@foo</span>
</span></span><span class=line><span class=cl><span class=nd>@bar</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>A</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 等价于：</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>A</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=k>pass</span>
</span></span><span class=line><span class=cl><span class=n>A</span> <span class=o>=</span> <span class=n>foo</span><span class=p>(</span><span class=n>bar</span><span class=p>(</span><span class=n>A</span><span class=p>))</span></span></span></code></pre></td></tr></table></div></div><p>装饰器在类声明上主要的用途是修改类的元数据，并且其修改不会被继承，典型的使用场景是内置装饰器<code>dataclass</code>，它改变了类的初始化过程，同时提供了属性冻结（只读）等特性。<code>dataclass</code>太复杂，下面以一个相对简单的<code>singleton</code>装饰器[<a href=https://realpython.com/primer-on-python-decorators/ target=_blank rel="external nofollow noopener noreferrer">8</a>]来实现装饰类：</p><div class=highlight id=id-33><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>functools</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>singleton</span><span class=p>(</span><span class=bp>cls</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Make a class a Singleton class (only one instance)&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@functools.wraps</span><span class=p>(</span><span class=bp>cls</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>wrapper_singleton</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>wrapper_singleton</span><span class=o>.</span><span class=n>instance</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>wrapper_singleton</span><span class=o>.</span><span class=n>instance</span> <span class=o>=</span> <span class=bp>cls</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>wrapper_singleton</span><span class=o>.</span><span class=n>instance</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 给wrapper函数创建instance属性并初始化为None</span>
</span></span><span class=line><span class=cl>    <span class=n>wrapper_singleton</span><span class=o>.</span><span class=n>instance</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>wrapper_singleton</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@singleton</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TheOne</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span></span></span></code></pre></td></tr></table></div></div><div class=highlight id=id-34><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span> <span class=o>=</span> <span class=n>TheOne</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>b</span> <span class=o>=</span> <span class=n>TheOne</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span> <span class=ow>is</span> <span class=n>b</span>
</span></span><span class=line><span class=cl><span class=kc>True</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>b</span><span class=o>.</span><span class=n>x</span>
</span></span><span class=line><span class=cl><span class=mi>5</span></span></span></code></pre></td></tr></table></div></div><p>使用<code>@singleton</code>装饰类后，类实例创建实际调用的是<code>wrapper_singleton</code>函数，函数内部控制返回共享实例，从而达到单例模式的效果。</p><h2 id=基于类实现装饰器>基于类实现装饰器</h2><p>除了使用函数外，用类也可以实现装饰器，一切只需要符合语法糖的规则，所以前提是类的实例也能像函数一样被调用，而这正是<code>callable</code> [<a href=https://docs.python.org/3/glossary.html#term-callable target=_blank rel="external nofollow noopener noreferrer">9</a>]特性所支持的。</p><p>在Python中，所有能够被调用（不管是有参还是无参）的对象都属于<code>callable</code>对象，除了最直观的函数，类也是<code>callable</code>对象（调用类即类的构造函数），实现了<code>__call__</code>方法的类实例也一样。</p><h3 id=类的__call__方法>类的<code>__call__</code>方法</h3><p>类的<code>__call__</code>方法[<a href=https://docs.python.org/3/reference/datamodel.html#emulating-callable-objects target=_blank rel="external nofollow noopener noreferrer">10</a>]达到的效果是把所有对实例的调用都转换为对实例<code>__call__</code>方法的调用：</p><div class=highlight id=id-35><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>A</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>name</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>say</span><span class=o>=</span><span class=s2>&#34;Hi&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>say</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>&#34;</span></span></span></code></pre></td></tr></table></div></div><div class=highlight id=id-36><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span> <span class=o>=</span> <span class=n>A</span><span class=p>(</span><span class=s2>&#34;World&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;Hi World&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>a</span><span class=p>(</span><span class=s2>&#34;Hello&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;Hello World&#39;</span></span></span></code></pre></td></tr></table></div></div><h3 id=基于类的装饰器实现>基于类的装饰器实现</h3><p>既然类的实例可以被调用，那么使用类来实现装饰器就不是问题了。尝试使用类来重新实现日志打印装饰器，按惯例，先回顾装饰器语法糖，看下期望达到的效果：</p><div class=highlight id=id-37><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>Log</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Log</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>greeting</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>say</span><span class=o>=</span><span class=s2>&#34;Hello&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=n>greeting</span><span class=p>(</span><span class=s2>&#34;World&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 应该等价于</span>
</span></span><span class=line><span class=cl><span class=n>Log</span><span class=p>(</span><span class=n>greeting</span><span class=p>)(</span><span class=s2>&#34;World&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@Log</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>greeting</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>say</span><span class=o>=</span><span class=s2>&#34;Hello&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=n>greeting</span><span class=p>(</span><span class=s2>&#34;World&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 应该等价于</span>
</span></span><span class=line><span class=cl><span class=n>Log</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)(</span><span class=n>greeting</span><span class=p>)(</span><span class=s2>&#34;World&#34;</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><p>在无参装饰器场景下，类构造器传入目标函数，<code>__call__</code>代理目标函数执行；在有参装饰器场景下，类构造器传入装饰器参数，<code>__call__</code>第一次调用传入目标函数，后续调用才是代理执行。具体实现如下：</p><div class=highlight id=id-38><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>functools</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Log</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>func</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>name</span><span class=o>=</span><span class=vm>__name__</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>fmt</span><span class=o>=</span><span class=s2>&#34;function </span><span class=si>%s</span><span class=s2> called with args=</span><span class=si>%s</span><span class=s2> kwargs=</span><span class=si>%s</span><span class=s2> and result=</span><span class=si>%s</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>level</span> <span class=o>=</span> <span class=n>level</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>name</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>fmt</span> <span class=o>=</span> <span class=n>fmt</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>__update_wrapper</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>__update_wrapper</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>func</span> <span class=o>=</span> <span class=n>func</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>func</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=n>functools</span><span class=o>.</span><span class=n>update_wrapper</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>func</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>__update_wrapper</span><span class=p>(</span><span class=n>args</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>log</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>level</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>fmt</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>func</span><span class=o>.</span><span class=vm>__name__</span><span class=p>,</span> <span class=n>args</span><span class=p>,</span> <span class=n>kwargs</span><span class=p>,</span> <span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span></span></span></code></pre></td></tr></table></div></div><div class=highlight id=id-39><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nd>@Log</span>
</span></span><span class=line><span class=cl><span class=o>...</span> <span class=k>def</span> <span class=nf>greeting</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>say</span><span class=o>=</span><span class=s2>&#34;Hello&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>say</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>!&#34;</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>greeting</span><span class=p>(</span><span class=s2>&#34;World&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>INFO</span><span class=p>:</span><span class=n>__main__</span><span class=p>:</span><span class=n>function</span> <span class=n>greeting</span> <span class=n>called</span> <span class=k>with</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;World&#39;</span><span class=p>,)</span> <span class=n>kwargs</span><span class=o>=</span><span class=p>{}</span> <span class=ow>and</span> <span class=n>result</span><span class=o>=</span><span class=n>Hello</span> <span class=n>World</span><span class=err>!</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;Hello World!&#39;</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=nd>@Log</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>WARNING</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span> <span class=k>def</span> <span class=nf>greeting</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>say</span><span class=o>=</span><span class=s2>&#34;Hello&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=s2>&#34;&#34;&#34;balabala&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=o>...</span>     <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>say</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>!&#34;</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>greeting</span><span class=p>(</span><span class=s2>&#34;World&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>WARNING</span><span class=p>:</span><span class=n>__main__</span><span class=p>:</span><span class=n>function</span> <span class=n>greeting</span> <span class=n>called</span> <span class=k>with</span> <span class=n>args</span><span class=o>=</span><span class=p>(</span><span class=s1>&#39;World&#39;</span><span class=p>,)</span> <span class=n>kwargs</span><span class=o>=</span><span class=p>{}</span> <span class=ow>and</span> <span class=n>result</span><span class=o>=</span><span class=n>Hello</span> <span class=n>World</span><span class=err>!</span>
</span></span><span class=line><span class=cl><span class=s1>&#39;Hello World!&#39;</span></span></span></code></pre></td></tr></table></div></div><p>这版实现看起来很繁琐，框架性的代码占比较大，可以抽取一个装饰器基类[<a href=https://tech.people-doc.com/python-class-based-decorators.html target=_blank rel="external nofollow noopener noreferrer">11</a>]，封装装饰器构造的公共代码，这样创建新的装饰器就会简洁很多了。</p><h3 id=小心状态化>小心状态化</h3><p>基于类的装饰器有个”副作用“，即每次语法糖解析过程都会创建一个类实例，而类实例是状态化的，这意味着同一目标函数的装饰器参数会在多次调用之间共享，所以除非你清楚自己在做什么，千万不要在<code>__call__</code>中对装饰器参数进行修改，我就在一个动态SQL执行装饰器中吃过这样的教训。举个例子，下面这段投硬币游戏的代码，一旦出现一次反面，结果就永远是反面了：</p><div class=highlight id=id-40><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ConsoleDisplay</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>func</span> <span class=o>=</span> <span class=n>func</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>message</span> <span class=o>=</span> <span class=s2>&#34;heads&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>res</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>res</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>message</span> <span class=o>=</span> <span class=s2>&#34;tails&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>print_message</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>print_message</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@ConsoleDisplay</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>flip_the_coin</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>([</span><span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>])</span></span></span></code></pre></td></tr></table></div></div><div class=highlight id=id-41><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>flip_the_coin</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>heads</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>flip_the_coin</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>tails</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>flip_the_coin</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>tails</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=c1># tails x 1000 (doge)</span></span></span></code></pre></td></tr></table></div></div><h2 id=总结>总结</h2><p>Python装饰器初看很简单，但是要构建一个通用且稳定的装饰器却是一项比较有挑战性的工作。</p><p>首先要知道<code>@</code>语法糖的规则，清楚无参装饰器、有参装饰器以及类装饰器三种场景各自的执行过程，这可以说是装饰器世界的三项基本法则。其次是关于头等函数，理解函数作为实参传递、内部函数以及函数作为返回值的用法，这些是装饰器世界运转的三个前提条件。</p><p>三项基本法则和三个前提条件是我在Python装饰器世界中发现的不变的部分，我把它们分享给你。</p><p>使用装饰器可以实现很多非常极客的功能，比如单例模式、缓存、数据校验、注册事件监听者、异步调用等，有些功能也许你已经使用过，下次再遇到不妨停下来看看源码，相信你已经能够一眼就看懂它的实现了。限于篇幅，实战部分不再展开，可参考资料[<a href=https://realpython.com/primer-on-python-decorators/ target=_blank rel="external nofollow noopener noreferrer">8</a>][<a href=https://coolshell.cn/articles/11265.html target=_blank rel="external nofollow noopener noreferrer">12</a>]，里面有很多实用装饰器，酷壳[<a href=https://coolshell.cn/articles/11265.html target=_blank rel="external nofollow noopener noreferrer">12</a>]中甚至引用了一个装饰器合集[<a href=https://wiki.python.org/moin/PythonDecoratorLibrary target=_blank rel="external nofollow noopener noreferrer">13</a>]，里面有40多个实用装饰器，牛哇。</p><p>最后，再奉上一份后台任务装饰器代码[<a href=https://gist.github.com/will4j/21f8cefbd32ea5684cb9353521cabceb target=_blank rel="external nofollow noopener noreferrer">14</a>]，作抛砖引玉之用，以上。</p><h2 id=后记>后记</h2><h3 id=设计思考>设计思考</h3><ol><li><p>函数式编程</p><p>作为一种编程范式，跟面向过程编程相比，函数式编程重视结果多于过程。这种倾向一方面体现为使用声明式而非指令式，即函数应该描述做了什么而不是怎么做；另一方面体现为不可变性或者说无状态化，即相同的参数调用函数总能得到一致的结果。</p><p>函数式编程实际上是将复杂的大问题分解成相对简单的独立子问题，简单子问题更容易求解和保证正确性。</p></li><li><p>关注点分离</p><p>封装的精髓所在，使用装饰器可以将一些通用逻辑抽离成独立的模块，比如日志、权限、缓存，一方面可以减少重复，另一方面可以让专业的“人”做专业的事情，日志装饰器只关注日志，它的目的就是把日志打出花来 :)。</p></li></ol><h3 id=编程考古>编程考古</h3><ol><li>2002年10月14日，Python 2.2.2 版本发布，引入了<code>staticmethod</code>和<code>classmethod</code>，使用方式<a href=https://www.python.org/download/releases/2.2.2/descrintro/#staticmethods target=_blank rel="external nofollow noopener noreferrer">纯靠手动</a>，如<code>foo = staticmethod(foo)</code>，期望未来会有一个语法来解决这个问题的种子在彼时就被埋下了。</li><li>2002年2月至2004年7月，与装饰器语法相关的讨论在社区持续进行，无数的提案被提交，如单词类的<code>as</code>、<code>using</code>等，符号类的<code>;...</code>、<code>&lt;…></code>、<code>|…</code>、<code>[…]</code>等，其中<code>[…]</code>是<code>@…</code>的强力竞争者。</li><li>2003年6月5日，定义装饰器规范的PEP 318<a href=https://peps.python.org/pep-0318/ target=_blank rel="external nofollow noopener noreferrer">2</a>创建，彼时的标题还是<code>pep 318, Decorators for Functions, Methods and Classes</code>，PEP 318经多次修改，历时近14个月，最终只支持函数和方法装饰器。</li><li>2004年6月7日至9日，欧洲Python开发者大会召开，Python之父Guido携带社区提案到会上进行讨论，但仍未有结论。</li><li>2004年7月30号，”Pie-Thon”挑战（2003年Parrot虚拟机开发者Dag发起的挑战，比较Python通过Parrot虚拟机和CPython运行的性能）在OSCON上兑现，作为赢家的Guido可以往Dag脸上丢一个奶油派，社区普遍认为这个事件对Guido最终决定使用<code>@</code>具有重要作用，因而很多人称之为“命运之派“。</li><li>2004年8月2日，Anthony在Guido授意下提交了一版<code>@</code><a href=https://mail.python.org/pipermail/python-dev/2004-August/046599.html target=_blank rel="external nofollow noopener noreferrer">装饰器实现</a>，因为形状类似派，Barry给它取了个外号叫”<a href=https://mail.python.org/pipermail/python-dev/2004-August/046613.html target=_blank rel="external nofollow noopener noreferrer">派-装饰器</a>“。</li></ol><h2 id=参考资料>参考资料</h2><p>[1]. <a href=https://zh.wikipedia.org/wiki/%E5%A4%B4%E7%AD%89%E5%87%BD%E6%95%B0 target=_blank rel="external nofollow noopener noreferrer">维基百科：头等函数</a><br>[2]. <a href=https://peps.python.org/pep-0318/ target=_blank rel="external nofollow noopener noreferrer">PEP 318 – Decorators for Functions and Methods</a><br>[3]. <a href="https://docs.python.org/3/reference/datamodel.html?highlight=__doc__#user-defined-functions" target=_blank rel="external nofollow noopener noreferrer">Python documentation: User-defined functions</a><br>[4]. <a href=https://docs.python.org/3/library/functools.html#functools.partial target=_blank rel="external nofollow noopener noreferrer">Python documentation: functools.partial</a><br>[5]. <a href=https://docs.python.org/3/library/functools.html#partial-objects target=_blank rel="external nofollow noopener noreferrer">Python documentation: partial-objects</a><br>[6]. <a href=https://python3-cookbook.readthedocs.io/zh-cn/latest/c09/p06_define_decorator_that_takes_optional_argument.html target=_blank rel="external nofollow noopener noreferrer">Python Cookbook 3rd Edition: 9.6 带可选参数的装饰器</a><br>[7]. <a href=https://peps.python.org/pep-3129/ target=_blank rel="external nofollow noopener noreferrer">PEP 3129 – Class Decorators</a><br>[8]. <a href=https://realpython.com/primer-on-python-decorators/ target=_blank rel="external nofollow noopener noreferrer">realpython: primer-on-python-decorators</a><br>[9]. <a href=https://docs.python.org/3/glossary.html#term-callable target=_blank rel="external nofollow noopener noreferrer">Python documentation: term-callable</a><br>[10]. <a href=https://docs.python.org/3/reference/datamodel.html#emulating-callable-objects target=_blank rel="external nofollow noopener noreferrer">Python documentation: Emulating callable objects</a><br>[11]. <a href=https://tech.people-doc.com/python-class-based-decorators.html target=_blank rel="external nofollow noopener noreferrer">people-doc: Class-based decorators with Python</a><br>[12]. <a href=https://coolshell.cn/articles/11265.html target=_blank rel="external nofollow noopener noreferrer">酷壳：PYTHON修饰器的函数式编程</a><br>[13]. <a href=https://wiki.python.org/moin/PythonDecoratorLibrary target=_blank rel="external nofollow noopener noreferrer">PythonDecoratorLibrary</a><br>[14]. <a href=https://gist.github.com/will4j/21f8cefbd32ea5684cb9353521cabceb target=_blank rel="external nofollow noopener noreferrer">gist: add background task with task register decorator</a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2023-11-17 14:56:11">更新于 2023-11-17&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/explain-python-decorator-in-detail/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://will4j.github.io/posts/explain-python-decorator-in-detail/ data-title="Python 装饰器详解" data-hashtags=python><i class="fa-brands fa-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://will4j.github.io/posts/explain-python-decorator-in-detail/ data-hashtag=python><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://will4j.github.io/posts/explain-python-decorator-in-detail/ data-title="Python 装饰器详解"><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/python/ class=post-tag>Python</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav></div></div><div id=comments><div id=giscus><script src=https://giscus.app/client.js data-repo=will4j/blog-comment-base data-repo-id=R_kgDOKus4vg data-category="Blog Comments" data-category-id=DIC_kwDOKus4vs4CbCP2 data-mapping=pathname data-strict=0 data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></article></main><footer class=footer><div class=footer-container><div class="footer-line powered order-1">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.120.4">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.2.18-lts.4"><img class=fixit-icon src=/fixit.min.svg alt="FixIt logo">&nbsp;FixIt</a></div><div class="footer-line copyright order-last" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2023</span><span class=author itemprop=copyrightHolder>
<a href=https://github.com/will4j target=_blank rel="external nofollow noopener noreferrer">水王</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics order-first"><span class=site-time title=网站运行中……><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden=true></i><span class="run-times ms-1">网站运行中……</span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class="variant-numeric d-none">0%</span></div><div class="fixed-button view-comments d-none" role=button aria-label=查看评论><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><div id=mask></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/typeit/index.umd.js defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:10},comment:{enable:!0,expired:!1,giscus:{darkTheme:"dark",lightTheme:"light"}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},data:{"typeit-header-desktop":"水王笔记","typeit-header-title-mobile":"水王笔记"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/index.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:30,threshold:.3,type:"fuse",useExtendedSearch:!1},siteTime:"2023-11-16T07:40:29+08:00",typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"typeit-header-desktop":["typeit-header-desktop"],"typeit-header-title-mobile":["typeit-header-title-mobile"]},duration:-1,loop:!1,speed:100}}</script><script src=/js/theme.min.js defer></script></body></html>